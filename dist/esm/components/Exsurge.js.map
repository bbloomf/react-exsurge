{"version":3,"sources":["../../../src/components/Exsurge.tsx"],"names":["React","useState","useRef","useEffect","useCallback","WebFont","exsurge","usePrevious","useArray","getNotYetLoadedFonts","resolveFont","Exsurge","gabc","useDropCap","annotation","contentEditable","alignment","width","height","zoom","selection","id","style","className","supertitle","title","subtitle","textLeft","textRight","defaultFont","defaultColor","defaultTitleAlignment","font","staffSize","baseFontSize","interSyllabicSpacing","spaceBetweenSystems","spaceAboveLyrics","textStyles","onScoreUpdate","onKeyDown","mapAnnotationSpansToTextLeft","supertitleSize","size","titleSize","subtitleSize","leftRightSize","leftRight","annotationArray","Array","textFontsArray","dropCap","al","choralSign","lyric","translation","textSizesArray","textColorsArray","color","titleAlignmentsArray","setRenderCount","ctxtRef","headerLenRef","fontLoaded","setFontLoaded","current","ctxt","ChantContext","TextMeasuringStrategy","Canvas","specialCharProperties","defaultSpecialCharText","specialCharText","char","toLowerCase","textAfterSpecialChar","setRubricColor","minSpaceAboveStaff","editable","useExtraTextOnly","handleScoreUpdate","score","gabcHeaderLen","scoreRef","getScore","ChantScore","process","env","NODE_ENV","loadedFontsRef","loadedFonts","fontsUsedButNotLoaded","Set","families","from","map","length","load","google","classes","fontactive","familyName","fvd","fontinactive","resolveLocalFont","newFont","interSyllabicMultiplier","setStaffHeight","interVerbalMultiplier","minSpaceBelowStaff","setFont","k","textType","Object","entries","TextTypes","key","textStyle","defaultSize","undefined","defaultLanguage","language","forceLayout","recreateDropCap","insertion","element","selectionInsertion","afterElementIndex","chantLine","previousSelectionInsertion","elementSelection","Gabc","updateMappingsFromSource","mappings","updateNotations","Annotations","titles","setSupertitle","setTitle","setSubtitle","setTextLeft","setTextRight","performLayout","layoutChantLines","paginate","count","newSelection","updateSelection","createReactSvg","svgTree","createElement","name","Fragment","props","children","divs","pages","page","i","createSvgTree"],"mappings":";AAAA,OAAOA,KAAP,IAAgBC,QAAhB,EAA0BC,MAA1B,EAAkCC,SAAlC,EAA6CC,WAA7C,QAAgE,OAAhE;AACA,OAAOC,OAAP,MAAoB,eAApB;AACA,OAAO,KAAKC,OAAZ,MAAyB,SAAzB;AAGA,OAAOC,WAAP,MAAwB,sBAAxB;AACA,OAAOC,QAAP,MAAqB,mBAArB;AACA,OAAOC,oBAAP,MAAiC,+BAAjC;AACA,OAAOC,WAAP,MAAwB,sBAAxB;;AAyCA,MAAMC,OAA+B,GAAG,CAAC;AACvCC,EAAAA,IADuC;AAEvCC,EAAAA,UAAU,GAAG,IAF0B;AAGvCC,EAAAA,UAAU,GAAG,EAH0B;AAIvCC,EAAAA,eAAe,GAAG,KAJqB;AAKvCC,EAAAA,SAAS,GAAG,OAL2B;AAMvCC,EAAAA,KAAK,GAAG,CAAC,CAN8B;AAOvCC,EAAAA,MAAM,GAAG,CAAC,CAP6B;AAQvCC,EAAAA,IARuC;AASvCC,EAAAA,SATuC;AAWvCC,EAAAA,EAXuC;AAYvCC,EAAAA,KAZuC;AAavCC,EAAAA,SAbuC;AAevCC,EAAAA,UAfuC;AAgBvCC,EAAAA,KAhBuC;AAiBvCC,EAAAA,QAjBuC;AAkBvCC,EAAAA,QAlBuC;AAmBvCC,EAAAA,SAnBuC;AAqBvCC,EAAAA,WAAW,GAAG,aArByB;AAsBvCC,EAAAA,YAAY,GAAG,SAtBwB;AAuBvCC,EAAAA,qBAAqB,GAAG,QAvBe;AAyBvCC,EAAAA,IAzBuC;AA0BvCC,EAAAA,SAAS,GAAG,IA1B2B;AA2BvCC,EAAAA,YAAY,GAAID,SAAS,GAAG,IAAb,GAAqB,IA3BG;AA4BvCE,EAAAA,oBAAoB,GAAG,GA5BgB;AA6BvCC,EAAAA,mBAAmB,GAAG,GA7BiB;AA8BvCC,EAAAA,gBAAgB,GAAG,IA9BoB;AAgCvCC,EAAAA,UAAU,GAAG,EAhC0B;AAkCvCC,EAAAA,aAlCuC;AAmCvCC,EAAAA,SAnCuC;AAoCvCC,EAAAA;AApCuC,CAAD,KAqCpB;AAAA;;AAClB,QAAMC,cAAc,4BAAGJ,UAAU,CAACd,UAAd,0DAAG,sBAAuBmB,IAA9C;AACA,QAAMC,SAAS,wBAAGN,UAAU,CAACb,KAAd,sDAAG,kBAAkBkB,IAApC;AACA,QAAME,YAAY,2BAAGP,UAAU,CAACZ,QAAd,yDAAG,qBAAqBiB,IAA1C;AACA,QAAMG,aAAa,4BAAGR,UAAU,CAACS,SAAd,0DAAG,sBAAsBJ,IAA5C;AAEA,QAAMK,eAAe,GAAGxC,QAAQ,CAC9BM,UAAU,YAAYmC,KAAtB,GAA8BnC,UAA9B,GAA2C,CAACA,UAAD,CADb,CAAhC;AAGA,QAAMoC,cAAc,GAAG1C,QAAQ,CAAC,2BAC9B8B,UAAU,CAACd,UADmB,2DAC9B,uBAAuBQ,IADO,wBAE9BM,UAAU,CAACb,KAFmB,uDAE9B,mBAAkBO,IAFY,2BAG9BM,UAAU,CAACZ,QAHmB,0DAG9B,sBAAqBM,IAHS,4BAI9BM,UAAU,CAACS,SAJmB,2DAI9B,uBAAsBf,IAJQ,2BAK9BM,UAAU,CAACxB,UALmB,0DAK9B,sBAAuBkB,IALO,yBAM9BM,UAAU,CAACa,OANmB,wDAM9B,oBAAoBnB,IANU,oBAO9BM,UAAU,CAACc,EAPmB,mDAO9B,eAAepB,IAPe,2BAQ9BM,UAAU,CAACe,UARmB,0DAQ9B,sBAAuBrB,IARO,uBAS9BM,UAAU,CAACgB,KATmB,sDAS9B,kBAAkBtB,IATY,2BAU9BM,UAAU,CAACiB,WAVmB,0DAU9B,sBAAwBvB,IAVM,EAW9BA,IAX8B,EAY9BH,WAZ8B,CAAD,CAA/B;AAcA,QAAM2B,cAAc,GAAGhD,QAAQ,CAAC,2BAC9B8B,UAAU,CAACd,UADmB,2DAC9B,uBAAuBmB,IADO,wBAE9BL,UAAU,CAACb,KAFmB,uDAE9B,mBAAkBkB,IAFY,2BAG9BL,UAAU,CAACZ,QAHmB,0DAG9B,sBAAqBiB,IAHS,4BAI9BL,UAAU,CAACS,SAJmB,2DAI9B,uBAAsBJ,IAJQ,4BAK9BL,UAAU,CAACxB,UALmB,2DAK9B,uBAAuB6B,IALO,0BAM9BL,UAAU,CAACa,OANmB,yDAM9B,qBAAoBR,IANU,qBAO9BL,UAAU,CAACc,EAPmB,oDAO9B,gBAAeT,IAPe,4BAQ9BL,UAAU,CAACe,UARmB,2DAQ9B,uBAAuBV,IARO,wBAS9BL,UAAU,CAACgB,KATmB,uDAS9B,mBAAkBX,IATY,4BAU9BL,UAAU,CAACiB,WAVmB,2DAU9B,uBAAwBZ,IAVM,CAAD,CAA/B;AAYA,QAAMc,eAAe,GAAGjD,QAAQ,CAAC,2BAC/B8B,UAAU,CAACd,UADoB,2DAC/B,uBAAuBkC,KADQ,wBAE/BpB,UAAU,CAACb,KAFoB,uDAE/B,mBAAkBiC,KAFa,2BAG/BpB,UAAU,CAACZ,QAHoB,0DAG/B,sBAAqBgC,KAHU,4BAI/BpB,UAAU,CAACS,SAJoB,2DAI/B,uBAAsBW,KAJS,4BAK/BpB,UAAU,CAACxB,UALoB,2DAK/B,uBAAuB4C,KALQ,0BAM/BpB,UAAU,CAACa,OANoB,yDAM/B,qBAAoBO,KANW,qBAO/BpB,UAAU,CAACc,EAPoB,oDAO/B,gBAAeM,KAPgB,4BAQ/BpB,UAAU,CAACe,UARoB,2DAQ/B,uBAAuBK,KARQ,wBAS/BpB,UAAU,CAACgB,KAToB,uDAS/B,mBAAkBI,KATa,4BAU/BpB,UAAU,CAACiB,WAVoB,2DAU/B,uBAAwBG,KAVO,CAAD,CAAhC;AAYA,QAAMC,oBAAoB,GAAGnD,QAAQ,CAAC,2BACpC8B,UAAU,CAACd,UADyB,2DACpC,uBAAuBR,SADa,wBAEpCsB,UAAU,CAACb,KAFyB,uDAEpC,mBAAkBT,SAFkB,2BAGpCsB,UAAU,CAACZ,QAHyB,0DAGpC,sBAAqBV,SAHe,CAAD,CAArC;AAMA,QAAM,GAAG4C,cAAH,IAAqB3D,QAAQ,CAAC,CAAD,CAAnC;AACA,QAAM4D,OAEL,GAAG3D,MAAM,EAFV;AAGA,QAAM4D,YAAY,GAAG5D,MAAM,CAAC,CAAD,CAA3B;AACA,QAAM,CAAC6D,UAAD,EAAaC,aAAb,IAA8B/D,QAAQ,CAAC,KAAD,CAA5C;;AAEA,MAAI,CAAC4D,OAAO,CAACI,OAAb,EAAsB;AACpB,QAAIC,IAAI,GAAIL,OAAO,CAACI,OAAR,GAAkB,IAAI3D,OAAO,CAAC6D,YAAZ,CAC5B7D,OAAO,CAAC8D,qBAAR,CAA8BC,MADF,CAA9B;AAIAH,IAAAA,IAAI,CAACI,qBAAL,CAA2B,aAA3B,IAA6C,YAA7C;AACAJ,IAAAA,IAAI,CAACI,qBAAL,CAA2B,cAA3B,IAA6C,QAA7C;AACAJ,IAAAA,IAAI,CAACI,qBAAL,CAA2B,WAA3B,IAA0C,MAA1C;AACAJ,IAAAA,IAAI,CAACI,qBAAL,CAA2B,aAA3B,IAA4C,KAA5C;;AACA,UAAMC,sBAAsB,GAAGL,IAAI,CAACM,eAAL,KAA0BC,IAAD,IAAkBA,IAA3C,CAA/B;;AACAP,IAAAA,IAAI,CAACM,eAAL,GAAwBC,IAAD,IAAUF,sBAAsB,CAACE,IAAD,CAAtB,CAA6BC,WAA7B,EAAjC;;AACAR,IAAAA,IAAI,CAACS,oBAAL,GAA4B,EAA5B;AACAT,IAAAA,IAAI,CAACU,cAAL,CAAoB,MAApB;AACAV,IAAAA,IAAI,CAACW,kBAAL,GAA0B,CAA1B;AAEAX,IAAAA,IAAI,CAACY,QAAL,GAAgB,CAAC,CAAC/D,eAAlB;AAEAmD,IAAAA,IAAI,CAACa,gBAAL,GAAwB,CAAChE,eAAzB;AAED;;AAED,QAAMmD,IAA0B,GAAGL,OAAO,CAACI,OAA3C;AACA9D,EAAAA,SAAS,CAAC,MAAM;AACd,QAAI,OAAOsC,4BAAP,KAAwC,UAA5C,EAAwD;AACtDyB,MAAAA,IAAI,CAACzB,4BAAL,GAAoCA,4BAApC;AACD;AACF,GAJQ,EAIN,CAACyB,IAAD,EAAOzB,4BAAP,CAJM,CAAT;AAMA,QAAMuC,iBAAiB,GAAG5E,WAAW,CACnC,CAAC6E,KAAD,EAAQC,aAAR,KAA0B;AACxB,QAAI,OAAO3C,aAAP,KAAyB,UAA7B,EACEA,aAAa,CAAC0C,KAAD,EAAQC,aAAR,CAAb;AACH,GAJkC,EAKnC,CAAC3C,aAAD,CALmC,CAArC;AAOA,QAAM4C,QAEL,GAAGjF,MAAM,EAFV;;AAGA,WAASkF,QAAT,GAAoB;AAClB,QAAI,CAACD,QAAQ,CAAClB,OAAd,EAAuBkB,QAAQ,CAAClB,OAAT,GAAmB,IAAI3D,OAAO,CAAC+E,UAAZ,CAAuBnB,IAAvB,CAAnB;AACvB,WAAOiB,QAAQ,CAAClB,OAAhB;AACD;;AAED,QAAMgB,KAAK,GAAGG,QAAQ,EAAtB;;AACA,MAAIE,OAAO,CAACC,GAAR,CAAYC,QAAZ,KAAyB,aAA7B,EAA4C,CAE3C,CAFD,CACE;AAGF;AACA;AACA;AACA;AACA;;;AACA,QAAMC,cAA6D,GAAGvF,MAAM,CAC1E,EAD0E,CAA5E;AAGAC,EAAAA,SAAS,CAAC,MAAM;AACd;AAEA;AACA,UAAMuF,WAAW,GAAGD,cAAc,CAACxB,OAAnC;AAAA,UACE0B,qBAAqB,GAAG,IAAIC,GAAJ,CACtBnF,oBAAoB,CAACyC,cAAD,EAAiBwC,WAAjB,CADE,CAD1B;AAAA,UAIEG,QAAQ,GAAG5C,KAAK,CAAC6C,IAAN,CAAWH,qBAAX,EAAkCI,GAAlC,CACR/D,IAAD,IAAW,GAAEA,IAAK,oBADT,CAJb;;AAOA,QAAI6D,QAAQ,CAACG,MAAb,EAAqB;AACnBhC,MAAAA,aAAa,CAAC,KAAD,CAAb;AACA3D,MAAAA,OAAO,CAAC4F,IAAR,CAAa;AACXC,QAAAA,MAAM,EAAE;AACNL,UAAAA;AADM,SADG;AAIXM,QAAAA,OAAO,EAAE,KAJE;AAKXC,QAAAA,UAAU,EAAE,CAACC,UAAD,EAAaC,GAAb,KAAqB;AAC/B,cAAIA,GAAG,KAAK,IAAZ,EAAkB;AAChBZ,YAAAA,WAAW,CAACW,UAAD,CAAX,GAA0B,IAA1B;AACA,gBAAI5F,oBAAoB,CAACyC,cAAD,EAAiBwC,WAAjB,CAApB,CAAkDM,MAAlD,KAA6D,CAAjE,EACE;AACAhC,cAAAA,aAAa,CAAC,IAAD,CAAb;AACH;AACF,SAZU;AAaXuC,QAAAA,YAAY,EAAE,CAACF,UAAD,EAAaC,GAAb,KAAqB;AACjC,cAAIA,GAAG,KAAK,IAAZ,EAAkB;AAChBZ,YAAAA,WAAW,CAACW,UAAD,CAAX,GAA0B,KAA1B;AACD;AACF;AAjBU,OAAb;AAmBD;AACF,GAjCQ,EAiCN,CAACnD,cAAD,CAjCM,CAAT;AAmCA,QAAMsD,gBAAgB,GAAGpG,WAAW,CACjCqG,OAAD,IACE/F,WAAW,CAAC+E,cAAc,CAACxB,OAAhB,EAAyBwC,OAAzB,EAAkCzE,IAAlC,EAAwCH,WAAxC,CAFqB,EAGlC,CAACG,IAAD,EAAOH,WAAP,CAHkC,CAApC,CAvJkB,CA6JlB;;AACA1B,EAAAA,SAAS,CAAC,MAAM;AAAA;;AACd;AACA,QAAIM,oBAAoB,CAACyC,cAAD,EAAiBuC,cAAc,CAACxB,OAAhC,CAApB,CAA6D+B,MAA7D,GAAsE,CAA1E,EACE;AACF,UAAMU,uBAAuB,GAAGvE,oBAAhC;AACA+B,IAAAA,IAAI,CAACyC,cAAL,CAAoB1E,SAApB;AACAiC,IAAAA,IAAI,CAACwC,uBAAL,GAA+BA,uBAA/B;AACAxC,IAAAA,IAAI,CAAC0C,qBAAL,GAA6BF,uBAAuB,GAAG,IAAvD;AACAxC,IAAAA,IAAI,CAAC9B,mBAAL,GAA2BA,mBAA3B;AACA8B,IAAAA,IAAI,CAAC2C,kBAAL,GAA0BxE,gBAA1B;AACA6B,IAAAA,IAAI,CAAC4C,OAAL,CAAaN,gBAAgB,uBAAClE,UAAU,CAACgB,KAAZ,uDAAC,mBAAkBtB,IAAnB,CAA7B,EAAuDE,YAAvD;;AACA,SAAK,IAAI,CAAC6E,CAAD,EAAIC,QAAJ,CAAT,IAA0BC,MAAM,CAACC,OAAP,CAAe5G,OAAO,CAAC6G,SAAvB,CAA1B,EAA6D;AAC3D;AACA,UAAIC,GAAG,GAAGL,CAAV;AACA,YAAMM,SAAS,GAAG/E,UAAU,CAAC8E,GAAD,CAAV,IAAmB,EAArC,CAH2D,CAI3D;;AACAlD,MAAAA,IAAI,CAAC5B,UAAL,CAAgB8E,GAAhB,EAAqBpF,IAArB,GAA4BwE,gBAAgB,CAACa,SAAS,CAACrF,IAAX,CAA5C,CAL2D,CAM3D;;AACA,UAAIgF,QAAQ,CAACM,WAAT,IAAwBD,SAAS,CAAC1E,IAAV,KAAmB4E,SAA/C,EAA0D;AACxDrD,QAAAA,IAAI,CAAC5B,UAAL,CAAgB8E,GAAhB,EAAqBzE,IAArB,GAA4BqE,QAAQ,CAACM,WAAT,CAC1BD,SAAS,CAAC1E,IAAV,GAAiBT,YADS,CAA5B;AAGD,OAX0D,CAY3D;;;AACAgC,MAAAA,IAAI,CAAC5B,UAAL,CAAgB8E,GAAhB,EAAqB1D,KAArB,GAA6B2D,SAAS,CAAC3D,KAAV,IAAmB5B,YAAhD,CAb2D,CAc3D;;AACA,cAAQsF,GAAR;AACE,aAAK,YAAL;AACA,aAAK,OAAL;AACA,aAAK,UAAL;AACElD,UAAAA,IAAI,CAAC5B,UAAL,CAAgB8E,GAAhB,EAAqBpG,SAArB,GACE,CAAAqG,SAAS,SAAT,IAAAA,SAAS,WAAT,YAAAA,SAAS,CAAErG,SAAX,KAAwBe,qBAD1B;AAEA;AACF;AAPF;AASD;;AACDmC,IAAAA,IAAI,CAACsD,eAAL,GAAuBlH,OAAO,CAACmH,QAAR,CAAiBzG,SAAjB,CAAvB;AACAiE,IAAAA,KAAK,CAACyC,WAAN,GAAoB,IAApB,CArCc,CAsCd;AACD,GAvCQ,EAuCN,CACD3D,UADC,EAED/B,IAFC,EAGDH,WAHC,EAIDI,SAJC,EAKDE,oBALC,EAMDC,mBANC,EAODF,YAPC,EAQDlB,SARC,EAUDwC,cAVC,EAWDN,cAXC,EAYDO,eAZC,EAaDE,oBAbC,EAeDO,IAfC,EAgBDe,KAhBC,CAvCM,CAAT;AA0DA9E,EAAAA,SAAS,CAAC,MAAM;AACd8E,IAAAA,KAAK,CAACpE,UAAN,GAAmBA,UAAnB;AACAoE,IAAAA,KAAK,CAAC0C,eAAN,CAAsBzD,IAAtB;AACAe,IAAAA,KAAK,CAACyC,WAAN,GAAoB,IAApB;AACA1C,IAAAA,iBAAiB,CAACC,KAAD,EAAQnB,YAAY,CAACG,OAArB,CAAjB;AACD,GALQ,EAKN,CAACpD,UAAD,EAAaoE,KAAb,EAAoBf,IAApB,EAA0Bc,iBAA1B,CALM,CAAT;AAOA,QAAM4C,SAAS,GACbxG,SAAS,IAAIA,SAAS,CAACyG,OAAvB,IAAkCzG,SAAS,CAACyG,OAAV,CAAkBD,SADtD;AAEA,QAAME,kBAAkB,GAAGF,SAAS,GAChC,OAAOA,SAAS,CAACG,iBAAjB,KAAuC,QAAvC,GACEH,SAAS,CAACG,iBADZ,GAEE,CAAC,CAAD,IAAMH,SAAS,CAACI,SAAV,IAAuB,CAAC,CAA9B,CAH8B,GAIhCT,SAJJ;AAKA,QAAMU,0BAA0B,GAAG1H,WAAW,CAACuH,kBAAD,CAA9C;AACA,QAAMI,gBAAgB,GAAI9G,SAAS,IAAIA,SAAS,CAACyG,OAAxB,IAAoC,IAA7D;AACA1H,EAAAA,SAAS,CAAC,MAAM;AACd2D,IAAAA,YAAY,CAACG,OAAb,GAAuB3D,OAAO,CAAC6H,IAAR,CAAaC,wBAAb,CACrBlE,IADqB,EAErBe,KAAK,CAACoD,QAFe,EAGrBzH,IAHqB,EAIrBkH,kBAJqB,EAKrBG,0BALqB,CAAvB;AAOAhD,IAAAA,KAAK,CAACqD,eAAN,CAAsBpE,IAAtB;AACAc,IAAAA,iBAAiB,CAACC,KAAD,EAAQnB,YAAY,CAACG,OAArB,CAAjB;AACD,GAVQ,EAUN,CAACrD,IAAD,EAAOkH,kBAAP,EAA2B5D,IAA3B,EAAiCe,KAAjC,EAAwCD,iBAAxC,CAVM,CAAT;AAYA7E,EAAAA,SAAS,CAAC,MAAM;AACd8E,IAAAA,KAAK,CAACnE,UAAN,GAAmBkC,eAAe,CAACgD,MAAhB,GACf,IAAI1F,OAAO,CAACiI,WAAZ,CAAwBrE,IAAxB,EAA8B,GAAGlB,eAAjC,CADe,GAEf,IAFJ;AAGAgC,IAAAA,iBAAiB,CAACC,KAAD,EAAQnB,YAAY,CAACG,OAArB,CAAjB;AACD,GALQ,EAKN,CAACjB,eAAD,EAAkBkB,IAAlB,EAAwBe,KAAxB,EAA+BD,iBAA/B,CALM,CAAT,CApPkB,CA2PlB;;AACA7E,EAAAA,SAAS,CAAC,MAAM;AACd8E,IAAAA,KAAK,CAACuD,MAAN,CAAaC,aAAb,CAA2BvE,IAA3B,EAAiC1C,UAAjC;AACAwD,IAAAA,iBAAiB,CAACC,KAAD,EAAQnB,YAAY,CAACG,OAArB,CAAjB;AACD,GAHQ,EAGN,CAACgB,KAAD,EAAQf,IAAR,EAAc1C,UAAd,EAA0BkB,cAA1B,EAA0CsC,iBAA1C,CAHM,CAAT;AAIA7E,EAAAA,SAAS,CAAC,MAAM;AACd8E,IAAAA,KAAK,CAACuD,MAAN,CAAaE,QAAb,CAAsBxE,IAAtB,EAA4BzC,KAA5B;AACAuD,IAAAA,iBAAiB,CAACC,KAAD,EAAQnB,YAAY,CAACG,OAArB,CAAjB;AACD,GAHQ,EAGN,CAACgB,KAAD,EAAQf,IAAR,EAAczC,KAAd,EAAqBmB,SAArB,EAAgCoC,iBAAhC,CAHM,CAAT;AAIA7E,EAAAA,SAAS,CAAC,MAAM;AACd8E,IAAAA,KAAK,CAACuD,MAAN,CAAaG,WAAb,CAAyBzE,IAAzB,EAA+BxC,QAA/B;AACAsD,IAAAA,iBAAiB,CAACC,KAAD,EAAQnB,YAAY,CAACG,OAArB,CAAjB;AACD,GAHQ,EAGN,CAACgB,KAAD,EAAQf,IAAR,EAAcxC,QAAd,EAAwBmB,YAAxB,EAAsCmC,iBAAtC,CAHM,CAAT;AAIA7E,EAAAA,SAAS,CAAC,MAAM;AACd8E,IAAAA,KAAK,CAACuD,MAAN,CAAaI,WAAb,CAAyB1E,IAAzB,EAA+BvC,QAA/B;AACAqD,IAAAA,iBAAiB,CAACC,KAAD,EAAQnB,YAAY,CAACG,OAArB,CAAjB;AACD,GAHQ,EAGN,CAACgB,KAAD,EAAQf,IAAR,EAAcvC,QAAd,EAAwBmB,aAAxB,EAAuCkC,iBAAvC,CAHM,CAAT;AAIA7E,EAAAA,SAAS,CAAC,MAAM;AACd8E,IAAAA,KAAK,CAACuD,MAAN,CAAaK,YAAb,CAA0B3E,IAA1B,EAAgCtC,SAAhC;AACAoD,IAAAA,iBAAiB,CAACC,KAAD,EAAQnB,YAAY,CAACG,OAArB,CAAjB;AACD,GAHQ,EAGN,CAACgB,KAAD,EAAQf,IAAR,EAActC,SAAd,EAAyBkB,aAAzB,EAAwCkC,iBAAxC,CAHM,CAAT;AAKA7E,EAAAA,SAAS,CAAC,MAAM;AACd,QAAI,CAAC4D,UAAL,EAAiB;AACjBkB,IAAAA,KAAK,CAAC6D,aAAN,CAAoB5E,IAApB,EAA0Be,KAAK,CAACyC,WAAhC;AACAzC,IAAAA,KAAK,CAACyC,WAAN,GAAoB,KAApB;AACD,GAJQ,EAIN,CACDzC,KADC,EAEDf,IAFC,EAGDH,UAHC,EAKDb,cALC,EAMDM,cANC,EAODC,eAPC,EAQDE,oBARC,EAUD1B,SAVC,EAWDE,oBAXC,EAYDC,mBAZC,EAaDF,YAbC,EAcDlB,SAdC,EAeDH,UAfC,EAgBDD,IAhBC,EAiBDkH,kBAjBC,EAkBD9E,eAlBC,EAmBDgC,iBAnBC,CAJM,CAAT,CAjRkB,CA2SlB;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA7E,EAAAA,SAAS,CAAC,MAAM;AACd,QAAI,CAAC4D,UAAL,EAAiB;AACjBkB,IAAAA,KAAK,CAAC8D,gBAAN,CAAuB7E,IAAvB,EAA6BjD,KAA7B;;AACA,QAAIC,MAAM,GAAG,CAAb,EAAgB;AACd+D,MAAAA,KAAK,CAAC+D,QAAN,CAAe9H,MAAf,EADc,CAEd;AACD;;AACD0C,IAAAA,cAAc,CAAEqF,KAAD,IAAWA,KAAK,GAAG,CAApB,CAAd;AACD,GARQ,EAQN,CACDhE,KADC,EAEDf,IAFC,EAGDH,UAHC,EAKDb,cALC,EAMDM,cANC,EAODC,eAPC,EAQDE,oBARC,EAUDnC,UAVC,EAWDC,KAXC,EAYDC,QAZC,EAaDC,QAbC,EAcDC,SAdC,EAgBDK,SAhBC,EAiBDE,oBAjBC,EAkBDC,mBAlBC,EAmBDF,YAnBC,EAoBDlB,SApBC,EAqBDH,UArBC,EAsBDD,IAtBC,EAuBDkH,kBAvBC,EAwBD9E,eAxBC,EAyBD/B,KAzBC,EA0BDC,MA1BC,EA2BD8D,iBA3BC,CARM,CAAT,CA3TkB,CAiWlB;;AACA7E,EAAAA,SAAS,CAAC,MAAM;AACd,QAAI+I,YAA+B,GAAG,EAAtC;AACA,QAAIhB,gBAAJ,EAAsBgB,YAAY,CAACrB,OAAb,GAAuBK,gBAAvB;AACtBjD,IAAAA,KAAK,CAACkE,eAAN,CAAsBD,YAAtB;AACAtF,IAAAA,cAAc,CAAEqF,KAAD,IAAWA,KAAK,GAAG,CAApB,CAAd;AACD,GALQ,EAKN,CAAChE,KAAD,EAAQf,IAAR,EAAcgE,gBAAd,CALM,CAAT;;AAOA,QAAMkB,cAAc,GAClBC,OADqB,IAGrB,OAAOA,OAAP,KAAmB,QAAnB,GACIA,OADJ,GAEIrJ,KAAK,CAACsJ,aAAN,CACED,OAAO,CAACE,IAAR,IAAgBvJ,KAAK,CAACwJ,QADxB,EAEEH,OAAO,CAACI,KAFV,EAGE,GAAG,CAACJ,OAAO,CAACK,QAAR,IAAoB,EAArB,EAAyB3D,GAAzB,CAA6BqD,cAA7B,CAHL,CALN;;AAWA,QAAMO,IAAI,GAAG,CAAC1E,KAAK,CAAC2E,KAAN,IAAe,EAAhB,EAAoB7D,GAApB,CAAwB,CAAC8D,IAAD,EAAOC,CAAP,kBACnC;AACE,IAAA,GAAG,EAAEA,CADP;AAEE,IAAA,EAAE,EAAEzI,EAAE,IAAIA,EAAE,GAAG,GAAL,GAAWyI,CAFvB;AAGE,IAAA,SAAS,EAAG,WAAUvI,SAAS,IAAI,EAAG,EAHxC;AAIE,IAAA,KAAK,EAAED,KAJT;AAKE,IAAA,SAAS,EAAEkB;AALb,KAOG4G,cAAc,CAACS,IAAI,CAACE,aAAL,CAAmB7F,IAAnB,EAAyB/C,IAAzB,CAAD,CAPjB,CADW,CAAb;AAYA,sBAAO,0CAAGwI,IAAH,CAAP;AACD,CAtaD;;;AAtCE/I,EAAAA,I;AACAC,EAAAA,U;AACAC,EAAAA,U;AACAC,EAAAA,e;AACAC,EAAAA,S,aAAY,S,EAAY,O;AACxBC,EAAAA,K;AACAC,EAAAA,M;AACAC,EAAAA,I;AAGAE,EAAAA,E;AACAC,EAAAA,K;AACAC,EAAAA,S;AAEAC,EAAAA,U;AACAC,EAAAA,K;AACAC,EAAAA,Q;AACAC,EAAAA,Q;AACAC,EAAAA,S;AAEAC,EAAAA,W;AACAC,EAAAA,Y;AACAC,EAAAA,qB;AAEAC,EAAAA,I;AACAE,EAAAA,Y;AACAD,EAAAA,S;AACAE,EAAAA,oB;AACAC,EAAAA,mB;AACAC,EAAAA,gB;;AAibF,eAAe1B,OAAf;AACA,cAAc,SAAd","sourcesContent":["import React, { useState, useRef, useEffect, useCallback } from \"react\";\nimport WebFont from \"webfontloader\";\nimport * as exsurge from \"exsurge\";\nimport { TextTypesOptions } from \"../interfaces/TextTypeOptions\";\nimport { LoadedFontsDictionary } from \"../interfaces/LoadedFontsDictionary\";\nimport usePrevious from \"../hooks/usePrevious\";\nimport useArray from \"../hooks/useArray\";\nimport getNotYetLoadedFonts from \"../utils/getNotYetLoadedFonts\";\nimport resolveFont from \"../utils/resolveFont\";\n\nexport interface ExsurgeProps {\n  gabc: string;\n  useDropCap?: boolean;\n  annotation?: string | string[];\n  contentEditable?: boolean;\n  alignment?: \"english\" | \"latin\";\n  width?: number;\n  height?: number;\n  zoom?: number;\n  selection?: exsurge.Selection;\n\n  id?: string;\n  style?: any;\n  className?: string;\n\n  supertitle?: string;\n  title?: string;\n  subtitle?: string;\n  textLeft?: string;\n  textRight?: string;\n\n  defaultFont?: string;\n  defaultColor?: string;\n  defaultTitleAlignment?: string;\n\n  font?: string;\n  baseFontSize?: number;\n  staffSize?: number;\n  interSyllabicSpacing?: number;\n  spaceBetweenSystems?: number;\n  spaceAboveLyrics?: number;\n\n  textStyles?: TextTypesOptions;\n\n  onScoreUpdate?(score: exsurge.ChantScore, gabceHeaderLen: number): any;\n  onKeyDown?(event: React.KeyboardEvent<HTMLDivElement>): any;\n  mapAnnotationSpansToTextLeft?: exsurge.AnnotationSpansToTextLeftMapper;\n}\n\nconst Exsurge: React.FC<ExsurgeProps> = ({\n  gabc,\n  useDropCap = true,\n  annotation = [],\n  contentEditable = false,\n  alignment = \"latin\",\n  width = -1,\n  height = -1,\n  zoom,\n  selection,\n\n  id,\n  style,\n  className,\n\n  supertitle,\n  title,\n  subtitle,\n  textLeft,\n  textRight,\n\n  defaultFont = \"EB Garamond\",\n  defaultColor = \"#000000\",\n  defaultTitleAlignment = \"center\",\n\n  font,\n  staffSize = 37.5,\n  baseFontSize = (staffSize * 19.2) / 37.5,\n  interSyllabicSpacing = 2.5,\n  spaceBetweenSystems = 1.5,\n  spaceAboveLyrics = 0.75,\n\n  textStyles = {},\n\n  onScoreUpdate,\n  onKeyDown,\n  mapAnnotationSpansToTextLeft,\n}: ExsurgeProps) => {\n  const supertitleSize = textStyles.supertitle?.size;\n  const titleSize = textStyles.title?.size;\n  const subtitleSize = textStyles.subtitle?.size;\n  const leftRightSize = textStyles.leftRight?.size;\n\n  const annotationArray = useArray(\n    annotation instanceof Array ? annotation : [annotation]\n  );\n  const textFontsArray = useArray([\n    textStyles.supertitle?.font,\n    textStyles.title?.font,\n    textStyles.subtitle?.font,\n    textStyles.leftRight?.font,\n    textStyles.annotation?.font,\n    textStyles.dropCap?.font,\n    textStyles.al?.font,\n    textStyles.choralSign?.font,\n    textStyles.lyric?.font,\n    textStyles.translation?.font,\n    font,\n    defaultFont,\n  ]);\n  const textSizesArray = useArray([\n    textStyles.supertitle?.size,\n    textStyles.title?.size,\n    textStyles.subtitle?.size,\n    textStyles.leftRight?.size,\n    textStyles.annotation?.size,\n    textStyles.dropCap?.size,\n    textStyles.al?.size,\n    textStyles.choralSign?.size,\n    textStyles.lyric?.size,\n    textStyles.translation?.size,\n  ]);\n  const textColorsArray = useArray([\n    textStyles.supertitle?.color,\n    textStyles.title?.color,\n    textStyles.subtitle?.color,\n    textStyles.leftRight?.color,\n    textStyles.annotation?.color,\n    textStyles.dropCap?.color,\n    textStyles.al?.color,\n    textStyles.choralSign?.color,\n    textStyles.lyric?.color,\n    textStyles.translation?.color,\n  ]);\n  const titleAlignmentsArray = useArray([\n    textStyles.supertitle?.alignment,\n    textStyles.title?.alignment,\n    textStyles.subtitle?.alignment,\n  ]);\n\n  const [, setRenderCount] = useState(0);\n  const ctxtRef: React.MutableRefObject<\n    exsurge.ChantContext | undefined\n  > = useRef();\n  const headerLenRef = useRef(0);\n  const [fontLoaded, setFontLoaded] = useState(false);\n\n  if (!ctxtRef.current) {\n    let ctxt = (ctxtRef.current = new exsurge.ChantContext(\n      exsurge.TextMeasuringStrategy.Canvas\n    ));\n\n    ctxt.specialCharProperties[\"font-family\"] = `Versiculum`;\n    ctxt.specialCharProperties[\"font-variant\"] = \"normal\";\n    ctxt.specialCharProperties[\"font-size\"] = \"120%\";\n    ctxt.specialCharProperties[\"font-weight\"] = \"400\";\n    const defaultSpecialCharText = ctxt.specialCharText || ((char: string) => char);\n    ctxt.specialCharText = (char) => defaultSpecialCharText(char).toLowerCase();\n    ctxt.textAfterSpecialChar = \"\";\n    ctxt.setRubricColor(\"#d00\");\n    ctxt.minSpaceAboveStaff = 0;\n\n    ctxt.editable = !!contentEditable;\n\n    ctxt.useExtraTextOnly = !contentEditable;\n\n  }\n\n  const ctxt: exsurge.ChantContext = ctxtRef.current;\n  useEffect(() => {\n    if (typeof mapAnnotationSpansToTextLeft === 'function') {\n      ctxt.mapAnnotationSpansToTextLeft = mapAnnotationSpansToTextLeft;\n    }\n  }, [ctxt, mapAnnotationSpansToTextLeft])\n\n  const handleScoreUpdate = useCallback(\n    (score, gabcHeaderLen) => {\n      if (typeof onScoreUpdate === \"function\")\n        onScoreUpdate(score, gabcHeaderLen);\n    },\n    [onScoreUpdate]\n  );\n  const scoreRef: React.MutableRefObject<\n    exsurge.ChantScore | undefined\n  > = useRef();\n  function getScore() {\n    if (!scoreRef.current) scoreRef.current = new exsurge.ChantScore(ctxt);\n    return scoreRef.current;\n  }\n\n  const score = getScore();\n  if (process.env.NODE_ENV === \"development\") {\n    // DEBUG: window.$score = score;\n  }\n\n  // load font.  Right now we use Google, but webfontloader supports\n  // • edgewebfonts.adobe.com\n  // • Fontdeck.com\n  // • Fonts.com\n  // • Typekit.com\n  const loadedFontsRef: React.MutableRefObject<LoadedFontsDictionary> = useRef(\n    {}\n  );\n  useEffect(() => {\n    // TODO...keep track of whether Bold, Italic, etc. are needed, and load them as necessary\n\n    // first calculate which distinct fonts we need:\n    const loadedFonts = loadedFontsRef.current,\n      fontsUsedButNotLoaded = new Set(\n        getNotYetLoadedFonts(textFontsArray, loadedFonts)\n      ),\n      families = Array.from(fontsUsedButNotLoaded).map(\n        (font) => `${font}:400,400i,700,700i`\n      );\n    if (families.length) {\n      setFontLoaded(false);\n      WebFont.load({\n        google: {\n          families,\n        },\n        classes: false,\n        fontactive: (familyName, fvd) => {\n          if (fvd === \"n4\") {\n            loadedFonts[familyName] = true;\n            if (getNotYetLoadedFonts(textFontsArray, loadedFonts).length === 0)\n              // all required fonts have been loaded:\n              setFontLoaded(true);\n          }\n        },\n        fontinactive: (familyName, fvd) => {\n          if (fvd === \"n4\") {\n            loadedFonts[familyName] = false;\n          }\n        },\n      });\n    }\n  }, [textFontsArray]);\n\n  const resolveLocalFont = useCallback(\n    (newFont?: string) =>\n      resolveFont(loadedFontsRef.current, newFont, font, defaultFont),\n    [font, defaultFont]\n  );\n\n  // Set fonts, sizes, and colors:\n  useEffect(() => {\n    // don't set the fonts if they haven't yet loaded:\n    if (getNotYetLoadedFonts(textFontsArray, loadedFontsRef.current).length > 0)\n      return;\n    const interSyllabicMultiplier = interSyllabicSpacing;\n    ctxt.setStaffHeight(staffSize);\n    ctxt.interSyllabicMultiplier = interSyllabicMultiplier;\n    ctxt.interVerbalMultiplier = interSyllabicMultiplier * 0.25;\n    ctxt.spaceBetweenSystems = spaceBetweenSystems;\n    ctxt.minSpaceBelowStaff = spaceAboveLyrics;\n    ctxt.setFont(resolveLocalFont(textStyles.lyric?.font), baseFontSize);\n    for (let [k, textType] of Object.entries(exsurge.TextTypes)) {\n      // Is there a better way to do type assertion than this?\n      let key = k as keyof exsurge.TextTypes;\n      const textStyle = textStyles[key] || {};\n      // font\n      ctxt.textStyles[key].font = resolveLocalFont(textStyle.font);\n      // size\n      if (textType.defaultSize && textStyle.size !== undefined) {\n        ctxt.textStyles[key].size = textType.defaultSize(\n          textStyle.size * baseFontSize\n        );\n      }\n      // color\n      ctxt.textStyles[key].color = textStyle.color || defaultColor;\n      // alignment\n      switch (key) {\n        case \"supertitle\":\n        case \"title\":\n        case \"subtitle\":\n          ctxt.textStyles[key].alignment =\n            textStyle?.alignment || defaultTitleAlignment;\n          break;\n        // TODO: allow padding to be changed? on dropCap and annotation\n      }\n    }\n    ctxt.defaultLanguage = exsurge.language[alignment];\n    score.forceLayout = true;\n    // eslint-disable-next-line\n  }, [\n    fontLoaded,\n    font,\n    defaultFont,\n    staffSize,\n    interSyllabicSpacing,\n    spaceBetweenSystems,\n    baseFontSize,\n    alignment,\n\n    textSizesArray,\n    textFontsArray,\n    textColorsArray,\n    titleAlignmentsArray,\n\n    ctxt,\n    score,\n  ]);\n\n  useEffect(() => {\n    score.useDropCap = useDropCap;\n    score.recreateDropCap(ctxt);\n    score.forceLayout = true;\n    handleScoreUpdate(score, headerLenRef.current);\n  }, [useDropCap, score, ctxt, handleScoreUpdate]);\n\n  const insertion =\n    selection && selection.element && selection.element.insertion;\n  const selectionInsertion = insertion\n    ? typeof insertion.afterElementIndex === \"number\"\n      ? insertion.afterElementIndex\n      : -1 - (insertion.chantLine || -1)\n    : undefined;\n  const previousSelectionInsertion = usePrevious(selectionInsertion);\n  const elementSelection = (selection && selection.element) || null;\n  useEffect(() => {\n    headerLenRef.current = exsurge.Gabc.updateMappingsFromSource(\n      ctxt,\n      score.mappings,\n      gabc,\n      selectionInsertion,\n      previousSelectionInsertion\n    );\n    score.updateNotations(ctxt);\n    handleScoreUpdate(score, headerLenRef.current);\n  }, [gabc, selectionInsertion, ctxt, score, handleScoreUpdate]);\n\n  useEffect(() => {\n    score.annotation = annotationArray.length\n      ? new exsurge.Annotations(ctxt, ...annotationArray)\n      : null;\n    handleScoreUpdate(score, headerLenRef.current);\n  }, [annotationArray, ctxt, score, handleScoreUpdate]);\n\n  // title effects:\n  useEffect(() => {\n    score.titles.setSupertitle(ctxt, supertitle);\n    handleScoreUpdate(score, headerLenRef.current);\n  }, [score, ctxt, supertitle, supertitleSize, handleScoreUpdate]);\n  useEffect(() => {\n    score.titles.setTitle(ctxt, title);\n    handleScoreUpdate(score, headerLenRef.current);\n  }, [score, ctxt, title, titleSize, handleScoreUpdate]);\n  useEffect(() => {\n    score.titles.setSubtitle(ctxt, subtitle);\n    handleScoreUpdate(score, headerLenRef.current);\n  }, [score, ctxt, subtitle, subtitleSize, handleScoreUpdate]);\n  useEffect(() => {\n    score.titles.setTextLeft(ctxt, textLeft);\n    handleScoreUpdate(score, headerLenRef.current);\n  }, [score, ctxt, textLeft, leftRightSize, handleScoreUpdate]);\n  useEffect(() => {\n    score.titles.setTextRight(ctxt, textRight);\n    handleScoreUpdate(score, headerLenRef.current);\n  }, [score, ctxt, textRight, leftRightSize, handleScoreUpdate]);\n\n  useEffect(() => {\n    if (!fontLoaded) return;\n    score.performLayout(ctxt, score.forceLayout);\n    score.forceLayout = false;\n  }, [\n    score,\n    ctxt,\n    fontLoaded,\n\n    textFontsArray,\n    textSizesArray,\n    textColorsArray,\n    titleAlignmentsArray,\n\n    staffSize,\n    interSyllabicSpacing,\n    spaceBetweenSystems,\n    baseFontSize,\n    alignment,\n    useDropCap,\n    gabc,\n    selectionInsertion,\n    annotationArray,\n    handleScoreUpdate,\n  ]);\n\n  // const appendSvgForPage = useCallback(pageI => {\n  //   const svgParent = divRefs.current[pageI];\n  //   while (svgParent && svgParent.firstChild)\n  //     svgParent.removeChild(svgParent.firstChild);\n  //   let svg = svgRefs.current[pageI];\n  //   if (svgParent && svg) svgParent.appendChild(svg);\n  // }, []);\n\n  // const divRefs = useRef([]),\n  //   svgRefs = useRef([]);\n  // const [pageCount, setPageCount] = useState(1);\n  // const addSvgRef = (ref, i) => {\n  //   divRefs.current[i] = ref;\n  //   appendSvgForPage(i);\n  // };\n\n  useEffect(() => {\n    if (!fontLoaded) return;\n    score.layoutChantLines(ctxt, width);\n    if (height > 0) {\n      score.paginate(height);\n      // setPageCount(score.pages.length);\n    }\n    setRenderCount((count) => count + 1);\n  }, [\n    score,\n    ctxt,\n    fontLoaded,\n\n    textFontsArray,\n    textSizesArray,\n    textColorsArray,\n    titleAlignmentsArray,\n\n    supertitle,\n    title,\n    subtitle,\n    textLeft,\n    textRight,\n\n    staffSize,\n    interSyllabicSpacing,\n    spaceBetweenSystems,\n    baseFontSize,\n    alignment,\n    useDropCap,\n    gabc,\n    selectionInsertion,\n    annotationArray,\n    width,\n    height,\n    handleScoreUpdate,\n  ]);\n\n  // selection:\n  useEffect(() => {\n    let newSelection: exsurge.Selection = {};\n    if (elementSelection) newSelection.element = elementSelection;\n    score.updateSelection(newSelection);\n    setRenderCount((count) => count + 1);\n  }, [score, ctxt, elementSelection]);\n\n  const createReactSvg = (\n    svgTree: exsurge.SvgTreeNode | string\n  ): React.ReactElement | string =>\n    typeof svgTree === \"string\"\n      ? svgTree\n      : React.createElement(\n          svgTree.name || React.Fragment,\n          svgTree.props,\n          ...(svgTree.children || []).map(createReactSvg)\n        );\n\n  const divs = (score.pages || []).map((page, i) => (\n    <div\n      key={i}\n      id={id && id + \"-\" + i}\n      className={`Exsurge ${className || \"\"}`}\n      style={style}\n      onKeyDown={onKeyDown}\n    >\n      {createReactSvg(page.createSvgTree(ctxt, zoom))}\n    </div>\n  ));\n\n  return <>{divs}</>;\n};\n\nexport default Exsurge;\nexport * from \"exsurge\";\n"],"file":"Exsurge.js"}